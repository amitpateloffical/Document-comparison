{% extends "layout/base.html" %}
{% load static %}

{% block title %}
    Report Preview
{% endblock title %}

{% block body %}

    <div class="container mx-auto my-12 px-6">
        <div class="text-start mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Report Preview</h1>
        </div>
        <div class="flex flex-col md:flex-row gap-5 justify-between mb-4 bg-slate-200 border rounded-lg py-3 px-6">
            <p class="text-gray-600 mt-2">Preview your report and view it directly within the page; use the chat feature to interact with the document for detailed insights.</p>
            <div class="flex gap-4 items-center">
                <a href="{% url "dashboard" %}" class="bg-cyan-700 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-300 ease-in-out">
                    Dashboard
                </a>
                <button onclick="history.back();" class="bg-cyan-700 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-300 ease-in-out">
                    Back
                </button>
            </div>
        </div>
        <div class="bg-white shadow-lg rounded-lg p-8 border border-gray-200">
            <div class="flex justify-between mb-6">
                <div class="flex text-slate-500 items-center p-2 rounded bg-slate-200">Report Number : <span class="text-blue-600 font-bold"> {{ report }}</span></div>
                <div class="flex items-center">
                    <a class="inline-flex gap-2 bg-pink-700 hover:bg-pink-600 text-white rounded-lg py-2 px-3 ml-4" href="{% get_media_prefix %}comparison-reports/{{ report }}.docx"><img src="{% static "images/download.png" %}" class="size-6" alt="" srcset=""> <span>Report</span></a>
                </div>
            </div>
            <div class="">
                <embed src="{{ pdf_path }}" type="application/pdf" class="w-full h-screen rounded-lg border" />
            </div>
        </div>
    </div>

    <div class="fixed bottom-10 left-1/2 transform -translate-x-1/2">
        <div class="relative inline-flex">
            <span class="animate-ping absolute inline-flex h-24 w-24 rounded-full bg-slate-900 opacity-75"></span>
            <img src="{% static 'images/mllogo.jpg' %}" alt="Chat PDF Button" id="chatPdfButton" class="w-24 h-24 rounded-full relative bg-sky-500 cursor-pointer">
        </div>
    </div>
                                                                                                       
    <!-- Modal structure -->
    <div id="chatPdfModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-lg p-6 w-11/12 md:w-1/2 ">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Chat with Document</h2>
                <button id="closeChat" class="text-gray-600 hover:text-gray-800 text-3xl font-bold z-50">&times;</button>
            </div>
            <div id="chatContainer" class="overflow-y-auto h-96 mb-4 border border-gray-200 p-4 rounded-lg">
                <!-- Chat content will be dynamically added here -->
            </div>
            <div class="flex gap-4 items-center"> 
                <input id="chatInput" type="text" class="border border-gray-300 rounded-lg w-full" placeholder="Type your message here...">
                <div id="sendMessage" class="hover:bg-gray-100 rounded-full p-2">
                    <img class="" src="{% static 'images/send.png' %}" width="40" height="40" alt="" srcset="">
                </div>
            </div>
        </div>
    </div>

    <script>
        let sourceId = null;
        const pdf_url = "{{ pdf_path }}";

        document.getElementById('chatPdfButton').addEventListener('click', async () => {
            document.getElementById('chatPdfModal').classList.remove('hidden');
            document.getElementById('loader').classList.remove('hidden');
            
            if (!sourceId) {
                sourceId = await uploadPdf();
            }
            if (sourceId) {
                document.getElementById('loader').classList.add('hidden');
                const chatContainer = document.getElementById('chatContainer');
                chatContainer.innerHTML += `
                    <div class="flex justify-start mb-3">
                        <span class="bg-gray-700 text-white py-2 px-3 rounded-lg max-w-xs md:max-w-xl break-words">Hello, how can i help you today!</span>
                    </div>`;
            } else {
                alert('Error uploading PDF. Please try again.');
            }
        });

        document.getElementById('closeChat').addEventListener('click', () => {
            document.getElementById('chatPdfModal').classList.add('hidden');
        });

        async function uploadPdf() {
            try {
                const response = await fetch('{% url "upload-pdf" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ file_url: "comparison-reports/{{ report }}.pdf" }) 
                });

                if (response.ok) {
                    const data = await response.json();
                    return data.sourceId; 
                } else {
                    const errorData = await response.json();
                    throw new Error(`Error uploading PDF: ${errorData.message || response.statusText}`);
                }
            } catch (error) {
                console.error('Error:', error);
                return null;
            }
        }

        document.getElementById('sendMessage').addEventListener('click', async () => {
            const message = document.getElementById('chatInput').value;
            if (message.trim()) {
                const chatContainer = document.getElementById('chatContainer');
                chatContainer.innerHTML += `
                    <div class="flex justify-end mb-3">
                        <span class="bg-blue-600 text-white py-2 px-3 rounded-lg max-w-xs md:max-w-xl break-words">${message}</span>
                    </div>`;

                try {
                    const response = await fetch('{% url "proxy-chat-pdf" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ question: message, source_id: sourceId })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        chatContainer.innerHTML += `
                           <div class="flex justify-start mb-3">
                                <span class="bg-gray-700 text-white py-2 px-3 rounded-lg max-w-xs md:max-w-xl  break-words">${data.content}</span>
                            </div>`;
                    } else {
                        chatContainer.innerHTML += `<div class="text-left text-red-600 mb-2">Error fetching response</div>`;
                    }
                } catch (error) {
                    chatContainer.innerHTML += `<div class="text-left text-red-600 mb-2">Error: ${error.message}</div>`;
                }

                document.getElementById('chatInput').value = '';
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        });
    </script>
{% endblock body %}
